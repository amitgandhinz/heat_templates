heat_template_version: 2013-05-23

description: HOT template to deploy Marconi infrastructure

parameters:
  image:
    type: string
    description: Name of image to use for servers
  flavor:
    type: string
    description: Flavor to use for servers
  web_nodes_count:
    type: number
    description: Number of web heads to use
  replica_set_size:
    type: number
    description: Number of mongo replica nodes to use
  admin_password:
    type: string
    description: Keystone Admin Password
  admin_tenant_name:
    type: string
    description: Keystone Admin Tenant
  admin_user:
    type: string
    description: Keystone Admin User
  admin_keystone_uri:
    type: string
    description: Keystone Admin URI
  keystone_uri:
    type: string
    description: Keystone URI
  keystone_version:
    type: string
    description: Keystone Version
  token_cache_time:
    type: number
    description: Keystone Token Cache time

resources:
  mongo_primary:
    type: OS::Nova::Server
    properties:
        flavor: { get_param: flavor }
        image: { get_param: image }
        name: marconi_mongo_001
        user_data_format: RAW
        config_drive: "true"
        user_data: |
          #!/bin/bash
          export DEBIAN_FRONTEND=noninteractive
          
          # install firewall rules
          IPTABLES="$(which iptables)"
            if [ "${IPTABLES}" ];then
              ${IPTABLES} -I INPUT -m tcp -p tcp --dport 27017 -j ACCEPT
              /sbin/service iptables save
            fi

          # install mongodb
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10
          echo 'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' | sudo tee /etc/apt/sources.list.d/mongodb.list

          sudo apt-get update
          sudo apt-get -y install mongodb-org

          mkdir /etc/sysconfig

          cat > "/etc/sysconfig/mongod"<<EOF
          logpath=/var/log/mongo/mongod.log
          logappend=true
          fork = true
          dbpath=/var/lib/mongo
          pidfilepath = /var/run/mongodb/mongod.pid
          replSet = catalog
          nojournal = true
          profile = 1
          slowms = 200
          oplogSize = 2048
          EOF

          # run mongo service
          sudo service mongod start
